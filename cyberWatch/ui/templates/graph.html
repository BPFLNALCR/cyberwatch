{% extends "base.html" %}
{% block content %}
<section class="cw-card">
  <div class="cw-card-header">
    <div>
      <p class="cw-eyebrow">Network topology</p>
      <h2 class="cw-h2">Graph Neighbors</h2>
    </div>
    <div id="graph-status" class="cw-banner"></div>
  </div>
  <form id="graph-form" class="cw-form">
    <label for="asn">ASN</label>
    <div class="cw-input-row">
      <input type="number" id="asn" name="asn" placeholder="13335" min="1" required>
      <button type="submit">Load neighbors</button>
    </div>
  </form>
  <div id="graph-data" class="cw-result"></div>
</section>
{% endblock %}

{% block scripts %}
<script>
  const graphForm = document.getElementById('graph-form');
  const graphData = document.getElementById('graph-data');
  const graphStatus = document.getElementById('graph-status');

  function renderNeighbors(data) {
    if (!data.neighbors || !data.neighbors.length) {
      return '<p class="cw-muted">No neighbors found.</p>';
    }
    // Each neighbor has: neighbor_asn, observed_count, min_rtt, max_rtt, last_seen
    const rows = data.neighbors.map((n) => {
      const asn = n.neighbor_asn || n;
      const count = n.observed_count != null ? n.observed_count : '—';
      const rttInfo = n.min_rtt != null && n.max_rtt != null 
        ? `${n.min_rtt.toFixed(1)}-${n.max_rtt.toFixed(1)}ms` 
        : '—';
      return `<div class="cw-neighbor-row">
        <span class="cw-chip cw-chip-link" data-asn="${asn}">AS${asn}</span>
        <span class="cw-muted">seen: ${count}</span>
        <span class="cw-muted">RTT: ${rttInfo}</span>
      </div>`;
    }).join('');
    return `<div class="cw-section"><h3>Neighbors of AS${data.asn}</h3><div class="cw-neighbor-list">${rows}</div></div>`;
  }

  function attachNeighborHandlers() {
    document.querySelectorAll('.cw-chip-link[data-asn]').forEach((el) => {
      el.addEventListener('click', () => {
        const asn = el.getAttribute('data-asn');
        if (asn) {
          document.getElementById('asn').value = asn;
          graphForm.dispatchEvent(new Event('submit', { bubbles: true, cancelable: true }));
        }
      });
    });
  }

  graphForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const asn = document.getElementById('asn').value.trim();
    if (!asn) return;

    showMessage(graphStatus, 'Loading...', 'info');
    graphData.innerHTML = '';

    try {
      const data = await fetchJson(`/graph/neighbors/${asn}`);
      showMessage(graphStatus, 'Loaded', 'success');
      graphData.innerHTML = renderNeighbors(data);
      attachNeighborHandlers();
    } catch (err) {
      showMessage(graphStatus, err.message || 'Failed to load neighbors', 'error');
      graphData.innerHTML = '';
    }
  });
</script>
{% endblock %}
