{% extends "base.html" %}
{% block content %}
<section class="cw-card">
  <div class="cw-card-header">
    <div>
      <p class="cw-eyebrow">Configuration</p>
      <h2 class="cw-h2">Settings</h2>
    </div>
    <div id="page-status" class="cw-banner"></div>
  </div>
  <p class="cw-body">Configure data sources and system settings for CyberWatch.</p>
</section>

<section class="cw-card">
  <div class="cw-card-header">
    <div>
      <p class="cw-eyebrow">DNS Data Source</p>
      <h2 class="cw-h2">Pi-hole Integration</h2>
    </div>
    <div id="pihole-status" class="cw-banner"></div>
  </div>
  
  <p class="cw-body">
    Connect to your Pi-hole to use DNS queries as measurement targets. 
    CyberWatch will automatically trace routes to domains you visit.
  </p>

  <div class="cw-alert cw-alert-info">
    <strong>Pi-hole v6:</strong> Use your web interface password as the API token.<br>
    <strong>Pi-hole v5:</strong> Find your API token in Settings → API → Show API token.
  </div>

  <form id="pihole-form" class="cw-form">
    <label for="pihole-url">Pi-hole URL</label>
    <div class="cw-input-row">
      <input type="url" id="pihole-url" name="base_url" 
             placeholder="http://192.168.1.10 or http://pi.hole" 
             required>
    </div>

    <label for="pihole-token">API Token / Password</label>
    <div class="cw-input-row">
      <input type="password" id="pihole-token" name="api_token" 
             placeholder="Your Pi-hole password or API token" 
             required>
      <button type="button" id="toggle-token" class="cw-btn-small">Show</button>
    </div>

    <label for="pihole-interval">Poll Interval (seconds)</label>
    <div class="cw-input-row">
      <input type="number" id="pihole-interval" name="poll_interval_seconds" 
             value="30" min="5" max="300" style="max-width: 120px;">
      <span class="cw-muted" style="align-self: center;">How often to fetch new DNS queries</span>
    </div>

    <div class="cw-input-row" style="margin-top: 0.5rem;">
      <label class="cw-checkbox-label">
        <input type="checkbox" id="pihole-enabled" name="enabled" checked>
        <span>Enable DNS collection from Pi-hole</span>
      </label>
    </div>

    <div class="cw-input-row" style="margin-top: 0.5rem;">
      <label class="cw-checkbox-label">
        <input type="checkbox" id="pihole-verify-ssl" name="verify_ssl" checked>
        <span>Verify SSL certificate</span>
      </label>
      <span class="cw-muted small" style="align-self: center; margin-left: 0.5rem;">Disable for self-signed certificates</span>
    </div>

    <div class="cw-input-row" style="margin-top: 1rem;">
      <button type="button" id="test-btn" class="cw-btn-secondary">Test Connection</button>
      <button type="submit" id="save-btn">Save Settings</button>
    </div>
  </form>

  <div id="test-result" class="cw-result" style="display: none;">
    <div class="cw-tile">
      <p class="cw-muted">Connection Test Result</p>
      <div id="test-result-content"></div>
    </div>
  </div>
</section>

<section class="cw-card">
  <div class="cw-card-header">
    <div>
      <p class="cw-eyebrow">Service Status</p>
      <h2 class="cw-h2">DNS Collector</h2>
    </div>
  </div>
  
  <p class="cw-body">
    The DNS collector service fetches queries from Pi-hole and enqueues them for measurement.
  </p>

  <div class="cw-grid">
    <div class="cw-tile">
      <p class="cw-muted">Collector Status</p>
      <div id="collector-status" class="cw-tile-value">—</div>
      <p id="collector-hint" class="cw-muted small"></p>
    </div>
    <div class="cw-tile">
      <p class="cw-muted">Last Heartbeat</p>
      <div id="collector-heartbeat" class="cw-tile-value">—</div>
      <p class="cw-muted small">Updated each polling cycle</p>
    </div>
  </div>

  <div class="cw-input-row" style="margin-top: 1rem;">
    <button type="button" id="restart-btn" class="cw-btn-secondary">
      <span id="restart-btn-text">Reload Settings</span>
    </button>
    <span id="restart-status" class="cw-muted" style="align-self: center;"></span>
  </div>

  <div class="cw-alert cw-alert-info" style="margin-top: 1rem;">
    <strong>Tip:</strong> Click "Reload Settings" after saving to apply changes without restarting the service manually.
  </div>
</section>
{% endblock %}

{% block scripts %}
<style>
  .cw-checkbox-label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    cursor: pointer;
    color: #c8d5ec;
  }
  .cw-checkbox-label input[type="checkbox"] {
    width: 18px;
    height: 18px;
    accent-color: #7cf3ff;
  }
  code {
    background: rgba(255, 255, 255, 0.08);
    padding: 0.2rem 0.5rem;
    border-radius: 4px;
    font-family: "Consolas", "Monaco", monospace;
    font-size: 0.85rem;
  }
</style>

<script>
  const piholeForm = document.getElementById("pihole-form");
  const piholeUrl = document.getElementById("pihole-url");
  const piholeToken = document.getElementById("pihole-token");
  const piholeInterval = document.getElementById("pihole-interval");
  const piholeEnabled = document.getElementById("pihole-enabled");
  const piholeVerifySsl = document.getElementById("pihole-verify-ssl");
  const testBtn = document.getElementById("test-btn");
  const saveBtn = document.getElementById("save-btn");
  const toggleBtn = document.getElementById("toggle-token");
  const piholeStatus = document.getElementById("pihole-status");
  const testResult = document.getElementById("test-result");
  const testResultContent = document.getElementById("test-result-content");
  const collectorStatus = document.getElementById("collector-status");
  const collectorHint = document.getElementById("collector-hint");

  // Toggle password visibility
  toggleBtn.addEventListener("click", () => {
    if (piholeToken.type === "password") {
      piholeToken.type = "text";
      toggleBtn.textContent = "Hide";
    } else {
      piholeToken.type = "password";
      toggleBtn.textContent = "Show";
    }
  });

  // Load existing settings
  async function loadSettings() {
    showMessage(piholeStatus, "Loading...", "info");
    try {
      const data = await fetchJson("/settings/pihole");
      if (data.configured) {
        piholeUrl.value = data.base_url || "";
        piholeInterval.value = data.poll_interval_seconds || 30;
        piholeEnabled.checked = data.enabled;
        piholeVerifySsl.checked = data.verify_ssl !== false;
        if (data.has_token) {
          piholeToken.placeholder = "••••••••••••• (saved)";
        }
        showMessage(piholeStatus, "Settings loaded", "success");
      } else {
        showMessage(piholeStatus, "Not configured", "info");
      }
    } catch (err) {
      showMessage(piholeStatus, err.message || "Failed to load settings", "error");
    }
  }

  // Test connection
  testBtn.addEventListener("click", async () => {
    if (!piholeUrl.value) {
      showMessage(piholeStatus, "Please enter a Pi-hole URL", "error");
      return;
    }
    if (!piholeToken.value && !piholeToken.placeholder.includes("saved")) {
      showMessage(piholeStatus, "Please enter an API token", "error");
      return;
    }

    testBtn.disabled = true;
    testBtn.textContent = "Testing...";
    testResult.style.display = "none";

    try {
      const payload = {
        base_url: piholeUrl.value,
        api_token: piholeToken.value || "USE_SAVED_TOKEN",
        enabled: piholeEnabled.checked,
        poll_interval_seconds: parseInt(piholeInterval.value) || 30,
        verify_ssl: piholeVerifySsl.checked,
      };

      const data = await fetchJson("/settings/pihole/test", {
        method: "POST",
        body: JSON.stringify(payload),
      });

      testResult.style.display = "block";
      
      if (data.success) {
        testResultContent.innerHTML = `
          <div class="cw-pill cw-pill-ok" style="margin-bottom: 0.5rem;">Success</div>
          <p style="margin: 0.25rem 0;">${data.message}</p>
          <p class="cw-muted small">API Version: ${data.api_version}</p>
        `;
      } else {
        testResultContent.innerHTML = `
          <div class="cw-pill cw-pill-bad" style="margin-bottom: 0.5rem;">Failed</div>
          <p style="margin: 0.25rem 0;">${data.message}</p>
        `;
      }
    } catch (err) {
      testResult.style.display = "block";
      testResultContent.innerHTML = `
        <div class="cw-pill cw-pill-bad" style="margin-bottom: 0.5rem;">Error</div>
        <p style="margin: 0.25rem 0;">${err.message || "Connection test failed"}</p>
      `;
    } finally {
      testBtn.disabled = false;
      testBtn.textContent = "Test Connection";
    }
  });

  // Save settings
  piholeForm.addEventListener("submit", async (e) => {
    e.preventDefault();

    if (!piholeUrl.value) {
      showMessage(piholeStatus, "Please enter a Pi-hole URL", "error");
      return;
    }

    saveBtn.disabled = true;
    saveBtn.textContent = "Saving...";
    showMessage(piholeStatus, "Saving...", "info");

    try {
      const payload = {
        base_url: piholeUrl.value,
        api_token: piholeToken.value || null,  // Send null if empty, backend will use existing
        enabled: piholeEnabled.checked,
        poll_interval_seconds: parseInt(piholeInterval.value) || 30,
        verify_ssl: piholeVerifySsl.checked,
      };

      const result = await fetchJson("/settings/pihole", {
        method: "POST",
        body: JSON.stringify(payload),
      });

      if (result.success === false) {
        showMessage(piholeStatus, result.message || "Failed to save", "error");
      } else {
        showMessage(piholeStatus, "Settings saved! Click 'Reload Settings' to apply.", "success");
        if (piholeToken.value) {
          piholeToken.value = "";
          piholeToken.placeholder = "••••••••••••• (saved)";
        }
      }
    } catch (err) {
      showMessage(piholeStatus, err.message || "Failed to save settings", "error");
    } finally {
      saveBtn.disabled = false;
      saveBtn.textContent = "Save Settings";
    }
  });

  // Restart collector
  const restartBtn = document.getElementById("restart-btn");
  const restartBtnText = document.getElementById("restart-btn-text");
  const restartStatus = document.getElementById("restart-status");
  const collectorHeartbeat = document.getElementById("collector-heartbeat");

  restartBtn.addEventListener("click", async () => {
    restartBtn.disabled = true;
    restartBtnText.textContent = "Requesting...";
    restartStatus.textContent = "";

    try {
      const result = await fetchJson("/settings/pihole/restart", {
        method: "POST",
      });

      restartStatus.textContent = result.message || "Restart requested";
      restartStatus.className = "cw-muted";
      
      // Refresh status after a short delay
      setTimeout(checkCollectorStatus, 2000);
    } catch (err) {
      restartStatus.textContent = err.message || "Failed to request restart";
      restartStatus.className = "cw-muted";
    } finally {
      restartBtn.disabled = false;
      restartBtnText.textContent = "Reload Settings";
    }
  });

  // Check collector status
  async function checkCollectorStatus() {
    try {
      const status = await fetchJson("/settings/pihole/status");
      
      if (status.configured && status.enabled) {
        collectorStatus.textContent = "Active";
        collectorStatus.className = "cw-pill cw-pill-ok";
        collectorHint.textContent = "Collector is configured and enabled.";
      } else if (status.configured && !status.enabled) {
        collectorStatus.textContent = "Disabled";
        collectorStatus.className = "cw-pill cw-pill-bad";
        collectorHint.textContent = "Enable collection to start gathering DNS data.";
      } else {
        collectorStatus.textContent = "Not Configured";
        collectorStatus.className = "cw-pill cw-pill-bad";
        collectorHint.textContent = "Enter Pi-hole settings above to configure.";
      }

      // Show heartbeat
      if (status.last_collector_heartbeat) {
        const hbDate = new Date(status.last_collector_heartbeat);
        const now = new Date();
        const diffMs = now - hbDate;
        const diffSec = Math.floor(diffMs / 1000);
        
        if (diffSec < 60) {
          collectorHeartbeat.textContent = `${diffSec}s ago`;
          collectorHeartbeat.className = "cw-pill cw-pill-ok";
        } else if (diffSec < 300) {
          collectorHeartbeat.textContent = `${Math.floor(diffSec / 60)}m ago`;
          collectorHeartbeat.className = "cw-pill cw-pill-ok";
        } else {
          collectorHeartbeat.textContent = `${Math.floor(diffSec / 60)}m ago`;
          collectorHeartbeat.className = "cw-pill cw-pill-bad";
        }
      } else {
        collectorHeartbeat.textContent = "No data";
        collectorHeartbeat.className = "";
      }
    } catch (err) {
      collectorStatus.textContent = "Unknown";
      collectorStatus.className = "";
      collectorHint.textContent = "Could not check status.";
      collectorHeartbeat.textContent = "—";
    }
  }

  // Initialize
  loadSettings();
  checkCollectorStatus();
  
  // Auto-refresh collector status every 10 seconds
  setInterval(checkCollectorStatus, 10000);
</script>
{% endblock %}
